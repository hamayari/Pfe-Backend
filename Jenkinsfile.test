pipeline {
    agent any
    
    environment {
        MAVEN_OPTS = '-Xmx512m -Xms256m'
    }
    
    stages {
        stage('üîç Checkout') {
            steps {
                echo "‚úÖ Code checked out"
                sh 'git --version || echo "Git OK"'
            }
        }
        
        stage('üèóÔ∏è Build') {
            agent {
                docker {
                    image 'maven:3.9-eclipse-temurin-21'
                    args '-v /root/.m2:/root/.m2'
                    reuseNode true
                }
            }
            steps {
                echo "üèóÔ∏è Building project..."
                sh '''
                    mvn clean compile \
                        -DskipTests \
                        -Dcheckstyle.skip=true \
                        -Dpmd.skip=true \
                        -Dspotbugs.skip=true
                '''
            }
        }
        
        stage('üìä SonarQube Analysis') {
            agent {
                docker {
                    image 'maven:3.9-eclipse-temurin-21'
                    args '-v /root/.m2:/root/.m2'
                    reuseNode true
                }
            }
            steps {
                echo "üìä Running SonarQube Analysis..."
                withSonarQubeEnv('SonarQube') {
                    sh '''
                        mvn sonar:sonar \
                            -Dsonar.projectKey=commercial-pfe-backend \
                            -Dsonar.projectName="Commercial PFE Backend" \
                            -Dsonar.host.url=http://host.docker.internal:9000 \
                            -Dcheckstyle.skip=true \
                            -Dpmd.skip=true \
                            -Dspotbugs.skip=true \
                            || echo "‚ö†Ô∏è SonarQube analysis completed with warnings"
                    '''
                }
            }
        }
        
        stage('‚è≥ Quality Gate') {
            steps {
                echo "‚è≥ Waiting for SonarQube Quality Gate..."
                timeout(time: 5, unit: 'MINUTES') {
                    script {
                        try {
                            def qg = waitForQualityGate()
                            if (qg.status != 'OK') {
                                echo "‚ö†Ô∏è Quality Gate status: ${qg.status}"
                                echo "‚ö†Ô∏è Continuing anyway for testing..."
                            } else {
                                echo "‚úÖ Quality Gate passed!"
                            }
                        } catch (Exception e) {
                            echo "‚ö†Ô∏è Quality Gate check failed: ${e.message}"
                            echo "‚ö†Ô∏è Continuing anyway for testing..."
                        }
                    }
                }
            }
        }
        
        stage('‚úÖ Test Complete') {
            steps {
                echo "‚úÖ Jenkins + SonarQube integration test SUCCESSFUL!"
                echo "üéâ Check SonarQube dashboard: http://localhost:9000"
            }
        }
    }
    
    post {
        success {
            echo "‚úÖ ========================================="
            echo "‚úÖ TEST R√âUSSI!"
            echo "‚úÖ Jenkins et SonarQube fonctionnent ensemble"
            echo "‚úÖ ========================================="
        }
        failure {
            echo "‚ùå ========================================="
            echo "‚ùå TEST √âCHOU√â"
            echo "‚ùå V√©rifiez les logs ci-dessus"
            echo "‚ùå ========================================="
        }
        always {
            echo "üìä R√©sultats disponibles sur:"
            echo "   - Jenkins: http://localhost:8090"
            echo "   - SonarQube: http://localhost:9000"
        }
    }
}
