// ============================================================
// JENKINSFILE OPTIMISÃ‰ - COMMERCIAL PFE BACKEND
// Pipeline CI/CD Rapide avec stages parallÃ¨les
// Temps estimÃ©: 5-7 minutes (au lieu de 15-20 min)
// ============================================================

pipeline {
    agent any
    
    environment {
        // Configuration Maven
        MAVEN_OPTS = '-Xmx3072m -Xms1024m'
        
        // Configuration Docker
        DOCKER_USERNAME = 'hamalak'
        BACKEND_IMAGE = "${DOCKER_USERNAME}/commercial-pfe-backend"
        IMAGE_TAG = "${env.BUILD_NUMBER}"
        
        // Configuration SonarQube
        SONAR_PROJECT_KEY = 'Commercial-PFE-Backend'
        SONAR_PROJECT_NAME = 'Commercial PFE Backend'
        
        // Configuration Application
        APP_VERSION = '1.0.0'
        
        // Git
        GIT_COMMIT_SHORT = sh(script: 'git rev-parse --short HEAD 2>/dev/null || echo "local"', returnStdout: true).trim()
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
        timeout(time: 30, unit: 'MINUTES')
        disableConcurrentBuilds()
        skipDefaultCheckout()
    }
    
    parameters {
        booleanParam(
            name: 'RUN_SONARQUBE',
            defaultValue: false,
            description: 'ExÃ©cuter l\'analyse SonarQube (ajoute 2-3 min)'
        )
        booleanParam(
            name: 'RUN_SECURITY_SCAN',
            defaultValue: false,
            description: 'ExÃ©cuter le scan de sÃ©curitÃ© (ajoute 1-2 min)'
        )
        booleanParam(
            name: 'PUSH_TO_DOCKERHUB',
            defaultValue: true,
            description: 'Pusher vers Docker Hub'
        )
    }
    
    stages {
        // ========================================
        // STAGE 1: INITIALISATION (5s)
        // ========================================
        stage('ðŸš€ Init') {
            steps {
                script {
                    echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                    echo "Build #${env.BUILD_NUMBER} | ${APP_VERSION} | ${GIT_COMMIT_SHORT}"
                    echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                    currentBuild.displayName = "#${env.BUILD_NUMBER}"
                }
            }
        }
        
        // ========================================
        // STAGE 2: CHECKOUT (10s)
        // ========================================
        stage('ðŸ“¥ Checkout') {
            steps {
                script {
                    try {
                        checkout scm
                    } catch (Exception e) {
                        checkout([
                            $class: 'GitSCM',
                            branches: [[name: '*/develop']],
                            userRemoteConfigs: [[url: 'https://github.com/hamayari/Pfe-Backend.git']]
                        ])
                    }
                }
            }
        }
        
        // ========================================
        // STAGE 3: BUILD MAVEN (1-2 min)
        // ========================================
        stage('ðŸ—ï¸ Build Maven') {
            agent {
                docker {
                    image 'maven:3.9-eclipse-temurin-21'
                    args '-v maven-repo:/root/.m2'
                    reuseNode true
                }
            }
            steps {
                echo 'ðŸ”¨ Compilation...'
                sh 'mvn clean compile -B -DskipTests -Dcheckstyle.skip -Dpmd.skip -Dspotbugs.skip'
                
                echo 'ðŸ“¦ Package JAR...'
                sh 'mvn package -B -DskipTests'
                
                archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
                echo 'âœ… Build Maven terminÃ©'
            }
        }
        
        // ========================================
        // STAGE 4: TESTS PARALLÃˆLES (2-3 min)
        // Chaque type de test dans son propre stage
        // ========================================
        stage('ðŸ§ª Tests & QualitÃ©') {
            parallel {
                // ========================================
                // 4.1: TESTS UNITAIRES SEULS
                // ========================================
                stage('Tests JUnit') {
                    agent {
                        docker {
                            image 'maven:3.9-eclipse-temurin-21'
                            args '-v maven-repo:/root/.m2'
                            reuseNode true
                        }
                    }
                    steps {
                        echo 'ðŸ§ª Tests unitaires...'
                        sh '''
                            mvn test \
                                -Dspring.profiles.active=test \
                                -Dmaven.test.failure.ignore=true \
                                -Dcheckstyle.skip \
                                -Dpmd.skip \
                                -Dspotbugs.skip \
                                -Djacoco.skip=true \
                                -B
                        '''
                    }
                    post {
                        always {
                            junit testResults: '**/target/surefire-reports/*.xml',
                                  allowEmptyResults: true
                        }
                    }
                }
                
                // ========================================
                // 4.2: JACOCO SEUL (rapide)
                // ========================================
                stage('Couverture JaCoCo') {
                    agent {
                        docker {
                            image 'maven:3.9-eclipse-temurin-21'
                            args '-v maven-repo:/root/.m2'
                            reuseNode true
                        }
                    }
                    steps {
                        echo 'ðŸ“Š GÃ©nÃ©ration rapport JaCoCo...'
                        sh '''
                            mvn jacoco:prepare-agent test jacoco:report \
                                -Dspring.profiles.active=test \
                                -Dmaven.test.failure.ignore=true \
                                -Dcheckstyle.skip \
                                -Dpmd.skip \
                                -Dspotbugs.skip \
                                -B
                        '''
                    }
                    post {
                        always {
                            jacoco(
                                execPattern: '**/target/jacoco.exec',
                                classPattern: '**/target/classes',
                                sourcePattern: '**/src/main/java',
                                exclusionPattern: '**/*Test*.class,**/entity/**,**/dto/**,**/model/**'
                            )
                        }
                    }
                }
                
                // ========================================
                // 4.3: CHECKSTYLE (rapide)
                // ========================================
                stage('Checkstyle') {
                    agent {
                        docker {
                            image 'maven:3.9-eclipse-temurin-21'
                            args '-v maven-repo:/root/.m2'
                            reuseNode true
                        }
                    }
                    steps {
                        echo 'ðŸ“ Checkstyle...'
                        sh 'mvn checkstyle:check -B || true'
                    }
                }
                
                // ========================================
                // 4.4: PMD (rapide)
                // ========================================
                stage('PMD') {
                    agent {
                        docker {
                            image 'maven:3.9-eclipse-temurin-21'
                            args '-v maven-repo:/root/.m2'
                            reuseNode true
                        }
                    }
                    steps {
                        echo 'ðŸ”Ž PMD...'
                        sh 'mvn pmd:check -B || true'
                    }
                }
            }
        }
        
        // ========================================
        // STAGE 5: SONARQUBE (OPTIONNEL, 2-3 min)
        // ========================================
        stage('ðŸ“Š SonarQube') {
            when {
                expression { params.RUN_SONARQUBE == true }
            }
            agent {
                docker {
                    image 'maven:3.9-eclipse-temurin-21'
                    args '-v maven-repo:/root/.m2'
                    reuseNode true
                }
            }
            steps {
                echo 'ðŸ“Š Analyse SonarQube...'
                script {
                    try {
                        withSonarQubeEnv('SonarQube') {
                            sh '''
                                mvn sonar:sonar \
                                    -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
                                    -Dsonar.projectName="${SONAR_PROJECT_NAME}" \
                                    -Dsonar.projectVersion=${APP_VERSION} \
                                    -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
                                    -B
                            '''
                        }
                        
                        timeout(time: 3, unit: 'MINUTES') {
                            def qg = waitForQualityGate()
                            if (qg.status != 'OK') {
                                echo "âš ï¸ Quality Gate: ${qg.status}"
                            }
                        }
                    } catch (Exception e) {
                        echo "âš ï¸ SonarQube: ${e.message}"
                    }
                }
            }
        }
        
        // ========================================
        // STAGE 6: DOCKER BUILD (1-2 min)
        // ========================================
        stage('ðŸ³ Docker Build') {
            steps {
                echo 'ðŸ³ Build image Docker...'
                sh """
                    docker build \
                        -t ${BACKEND_IMAGE}:${IMAGE_TAG} \
                        -t ${BACKEND_IMAGE}:latest \
                        --build-arg VERSION=${APP_VERSION} \
                        .
                """
                echo 'âœ… Image crÃ©Ã©e'
            }
        }
        
        // ========================================
        // STAGE 7: DOCKER TEST (1 min)
        // ========================================
        stage('ðŸ§ª Docker Test') {
            steps {
                echo 'ðŸ§ª Test conteneur...'
                script {
                    try {
                        sh '''
                            docker stop backend-test mongodb-test 2>/dev/null || true
                            docker rm backend-test mongodb-test 2>/dev/null || true
                            docker network rm test-network 2>/dev/null || true
                        '''
                        
                        sh 'docker network create test-network'
                        
                        sh """
                            docker run -d \
                                --name mongodb-test \
                                --network test-network \
                                -e MONGO_INITDB_ROOT_USERNAME=admin \
                                -e MONGO_INITDB_ROOT_PASSWORD=admin123 \
                                mongo:latest
                        """
                        sleep 10
                        
                        sh """
                            docker run -d \
                                --name backend-test \
                                --network test-network \
                                -p 8081:8080 \
                                -e SPRING_DATA_MONGODB_HOST=mongodb-test \
                                -e SPRING_DATA_MONGODB_PORT=27017 \
                                -e SPRING_DATA_MONGODB_USERNAME=admin \
                                -e SPRING_DATA_MONGODB_PASSWORD=admin123 \
                                -e SPRING_DATA_MONGODB_DATABASE=commercial_pfe \
                                -e SPRING_DATA_MONGODB_AUTHENTICATION_DATABASE=admin \
                                ${BACKEND_IMAGE}:${IMAGE_TAG}
                        """
                        sleep 30
                        
                        def health = sh(
                            script: 'curl -f http://localhost:8081/actuator/health 2>/dev/null || echo "FAILED"',
                            returnStdout: true
                        ).trim()
                        
                        if (health.contains('UP')) {
                            echo 'âœ… Health check OK'
                        } else {
                            echo 'âš ï¸ Health check timeout'
                        }
                    } finally {
                        sh '''
                            docker stop backend-test mongodb-test 2>/dev/null || true
                            docker rm backend-test mongodb-test 2>/dev/null || true
                            docker network rm test-network 2>/dev/null || true
                        '''
                    }
                }
            }
        }
        
        // ========================================
        // STAGE 8: SECURITY SCAN (OPTIONNEL, 1-2 min)
        // ========================================
        stage('ðŸ”’ Security') {
            when {
                expression { params.RUN_SECURITY_SCAN == true }
            }
            steps {
                echo 'ðŸ”’ Scan sÃ©curitÃ©...'
                script {
                    try {
                        sh """
                            docker run --rm \
                                -v /var/run/docker.sock:/var/run/docker.sock \
                                aquasec/trivy image \
                                --severity HIGH,CRITICAL \
                                --exit-code 0 \
                                ${BACKEND_IMAGE}:${IMAGE_TAG}
                        """
                    } catch (Exception e) {
                        echo "âš ï¸ Trivy: ${e.message}"
                    }
                }
            }
        }
        
        // ========================================
        // STAGE 9: PUSH DOCKER HUB (30s-1min)
        // ========================================
        stage('ðŸ“¤ Push Docker') {
            when {
                allOf {
                    expression { params.PUSH_TO_DOCKERHUB == true }
                    anyOf {
                        branch 'develop'
                        branch 'main'
                    }
                }
            }
            steps {
                echo 'ðŸ“¤ Push Docker Hub...'
                withCredentials([usernamePassword(
                    credentialsId: 'dockerhub-credentials',
                    usernameVariable: 'DOCKER_USER',
                    passwordVariable: 'DOCKER_PASS'
                )]) {
                    sh '''
                        echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin
                        docker push ${BACKEND_IMAGE}:${IMAGE_TAG}
                        docker push ${BACKEND_IMAGE}:latest
                        docker logout
                    '''
                }
                echo 'âœ… Images poussÃ©es'
            }
        }
        
        // ========================================
        // STAGE 10: RAPPORT (5s)
        // ========================================
        stage('ðŸ“Š Rapport') {
            steps {
                script {
                    def duration = currentBuild.durationString.replace(' and counting', '')
                    echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                    echo "âœ… BUILD #${env.BUILD_NUMBER} - SUCCESS"
                    echo "â±ï¸  DurÃ©e: ${duration}"
                    echo "ðŸ“¦ JAR: target/*.jar"
                    echo "ðŸ³ Docker: ${BACKEND_IMAGE}:${IMAGE_TAG}"
                    echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                }
            }
        }
    }
    
    post {
        success {
            echo 'âœ… PIPELINE RÃ‰USSIE!'
        }
        failure {
            echo 'âŒ PIPELINE Ã‰CHOUÃ‰E'
        }
        always {
            sh '''
                docker stop backend-test mongodb-test 2>/dev/null || true
                docker rm backend-test mongodb-test 2>/dev/null || true
                docker network rm test-network 2>/dev/null || true
                docker image prune -f 2>/dev/null || true
            '''
            
            publishHTML([
                allowMissing: true,
                alwaysLinkToLastBuild: true,
                keepAll: true,
                reportDir: 'target/site/jacoco',
                reportFiles: 'index.html',
                reportName: 'JaCoCo Coverage'
            ])
        }
    }
}
