â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ARCHITECTURE DU SYSTÃˆME D'ALERTES - VERSION FINALE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¯ OBJECTIF: 1 alerte = 1 facture OVERDUE (sans duplication)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  SERVICES ACTIFS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… KpiEvaluatorService
   - Service PRINCIPAL pour crÃ©er/mettre Ã  jour les alertes
   - MÃ©thode: analyzeAllKpis()
   - Logique UPSERT: update si existe, create sinon
   - Protection: synchronized + flag isAnalyzing
   - Transaction: @Transactional pour garantir cohÃ©rence

âœ… AlertScheduler (NOUVEAU)
   - Scheduler UNIQUE pour gÃ©nÃ©ration automatique
   - FrÃ©quence: Toutes les 5 minutes
   - Appelle: KpiEvaluatorService.analyzeAllKpis()
   - Localisation: demo/scheduler/AlertScheduler.java

âœ… ConventionAlertScheduler
   - GÃ¨re les alertes d'Ã‰CHÃ‰ANCE des conventions
   - FrÃ©quence: Tous les jours Ã  9h00
   - Scope: Conventions uniquement (pas les factures)

âœ… ConventionStatusScheduler
   - Met Ã  jour les STATUTS des conventions
   - FrÃ©quence: Tous les jours Ã  1h00
   - Scope: Mise Ã  jour statuts (ACTIVE, EXPIRED, etc.)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  SERVICES DÃ‰SACTIVÃ‰S (pour Ã©viter doublons)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âŒ KpiAnalysisScheduler
   - DÃ‰SACTIVÃ‰: @Component commentÃ©
   - Raison: CrÃ©ait des doublons avec AlertScheduler
   - MarquÃ©: @Deprecated

âŒ InvoiceAlertService.checkOverdueInvoices()
   - DÃ‰SACTIVÃ‰: MarquÃ© @Deprecated
   - Raison: Utilisait dimension "INVOICE" au lieu de "FACTURE"
   - RemplacÃ© par: KpiEvaluatorService

âŒ AutomaticKpiAlertService.checkKpiAnomalies()
   - DÃ‰SACTIVÃ‰: MarquÃ© @Deprecated
   - Raison: Logique obsolÃ¨te
   - RemplacÃ© par: KpiEvaluatorService

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  FLUX DE GÃ‰NÃ‰RATION DES ALERTES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. AlertScheduler (toutes les 5 min)
   â†“
2. KpiEvaluatorService.analyzeAllKpis()
   â†“
3. analyzeOverdueInvoices() [@Transactional]
   â†“
4. Pour chaque facture OVERDUE:
   - VÃ©rifier si alerte existe (findByRelatedInvoiceIdAndAlertStatus)
   - Si OUI â†’ updateOverdueInvoiceAlert()
   - Si NON â†’ createNewOverdueInvoiceAlert()
   â†“
5. Supprimer les alertes obsolÃ¨tes (factures plus OVERDUE)
   â†“
6. RÃ©sultat: Exactement 1 alerte par facture OVERDUE

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  PROTECTION CONTRE LES DOUBLONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ”’ Verrouillage concurrent:
   - Flag: isAnalyzing (volatile boolean)
   - MÃ©thode: synchronized analyzeAllKpis()
   - Si analyse en cours â†’ appel ignorÃ©

ğŸ”’ Transaction atomique:
   - @Transactional sur analyzeOverdueInvoices()
   - Tout ou rien (rollback si erreur)

ğŸ”’ Nettoyage intelligent:
   - Supprime alertes dimension "FACTURE" ET "INVOICE"
   - Supprime alertes pour factures plus OVERDUE
   - Garde seulement les alertes valides

ğŸ”’ Identification unique:
   - ClÃ©: relatedInvoiceId + alertStatus="PENDING_DECISION"
   - EmpÃªche crÃ©ation de doublons

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ENDPOINTS API
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

POST /api/kpi/analyze
   â†’ DÃ©clenche manuellement l'analyse

GET /api/kpi-alerts/status
   â†’ Compare factures OVERDUE vs alertes

GET /api/kpi-alerts/diagnostic
   â†’ Diagnostic complet du systÃ¨me
   â†’ DÃ©tecte alertes orphelines
   â†’ Liste problÃ¨mes

DELETE /api/kpi/alerts
   â†’ Supprime toutes les alertes

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  SCRIPTS UTILITAIRES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

reset-alerts-clean.ps1
   â†’ Supprime toutes les alertes
   â†’ RecrÃ©e proprement les alertes actuelles

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  GARANTIES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… 1 alerte = 1 facture OVERDUE (jamais plus, jamais moins)
âœ… Pas de doublons (protection multi-niveaux)
âœ… Pas d'incrÃ©mentation (UPSERT au lieu de CREATE)
âœ… CohÃ©rence garantie (transaction atomique)
âœ… Nettoyage automatique (alertes obsolÃ¨tes supprimÃ©es)
âœ… Un seul scheduler actif (AlertScheduler)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
