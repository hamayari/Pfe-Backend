// ============================================================
// JENKINSFILE PRODUCTION - COMMERCIAL PFE BACKEND
// Pipeline CI/CD Complet avec toutes les fonctionnalit√©s
// ============================================================

pipeline {
    agent any
    
    environment {
        // Configuration Maven
        MAVEN_OPTS = '-Xmx3072m -Xms1024m'
        JAVA_HOME = '/opt/java/openjdk'
        
        // Configuration Docker
        DOCKER_USERNAME = 'hamalak'
        BACKEND_IMAGE = "${DOCKER_USERNAME}/commercial-pfe-backend"
        IMAGE_TAG = "${env.BUILD_NUMBER}"
        
        // Configuration SonarQube
        SONAR_PROJECT_KEY = 'Commercial-PFE-Backend'
        SONAR_PROJECT_NAME = 'Commercial PFE Backend'
        
        // Configuration Application
        APP_VERSION = '1.0.0'
        APP_NAME = 'Commercial PFE Backend'
        
        // Git
        GIT_COMMIT_SHORT = sh(script: 'git rev-parse --short HEAD 2>/dev/null || echo "local"', returnStdout: true).trim()
        
        // M√©triques de qualit√©
        COVERAGE_THRESHOLD = '80'
        BRANCH_COVERAGE_THRESHOLD = '75'
    }
    
    options {
        buildDiscarder(logRotator(
            numToKeepStr: '10',
            artifactNumToKeepStr: '5'
        ))
        timestamps()
        timeout(time: 2, unit: 'HOURS')
        disableConcurrentBuilds()
        skipDefaultCheckout()
    }
    
    parameters {
        choice(
            name: 'BUILD_TYPE',
            choices: ['FULL', 'QUICK', 'SECURITY_ONLY'],
            description: 'Type de build √† ex√©cuter'
        )
        booleanParam(
            name: 'SKIP_TESTS',
            defaultValue: false,
            description: 'Ignorer les tests (non recommand√©)'
        )
        booleanParam(
            name: 'PUSH_TO_DOCKERHUB',
            defaultValue: true,
            description: 'Pusher les images vers Docker Hub'
        )
        booleanParam(
            name: 'RUN_INTEGRATION_TESTS',
            defaultValue: true,
            description: 'Ex√©cuter les tests d\'int√©gration'
        )
        booleanParam(
            name: 'DEPLOY_TO_STAGING',
            defaultValue: false,
            description: 'D√©ployer automatiquement en staging'
        )
    }
    
    stages {
        // ========================================
        // STAGE 1: INITIALISATION
        // ========================================
        stage('üöÄ Initialisation') {
            steps {
                script {
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo "           ${APP_NAME}"
                    echo '           PIPELINE CI/CD PRODUCTION'
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo "üì¶ Build: #${env.BUILD_NUMBER}"
                    echo "üè∑Ô∏è  Version: ${APP_VERSION}"
                    echo "üåø Branch: ${env.BRANCH_NAME ?: 'develop'}"
                    echo "üìù Commit: ${GIT_COMMIT_SHORT}"
                    echo "üë§ D√©marr√© par: ${env.BUILD_USER ?: 'Jenkins'}"
                    echo "üîß Type: ${params.BUILD_TYPE}"
                    echo "üìÖ Date: ${new Date().format('yyyy-MM-dd HH:mm:ss')}"
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    
                    // D√©finir le nom du build
                    currentBuild.displayName = "#${env.BUILD_NUMBER} - ${params.BUILD_TYPE}"
                    currentBuild.description = "Commit: ${GIT_COMMIT_SHORT}"
                }
            }
        }
        
        // ========================================
        // STAGE 2: CHECKOUT
        // ========================================
        stage('üì• Checkout Code') {
            steps {
                echo 'üì• R√©cup√©ration du code source...'
                script {
                    try {
                        checkout scm
                    } catch (Exception e) {
                        echo '‚ö†Ô∏è SCM non disponible, checkout manuel...'
                        checkout([
                            $class: 'GitSCM',
                            branches: [[name: '*/develop']],
                            userRemoteConfigs: [[
                                url: 'https://github.com/hamayari/Pfe-Backend.git'
                            ]]
                        ])
                    }
                }
                
                script {
                    // V√©rifier les fichiers critiques
                    def criticalFiles = ['pom.xml', 'Dockerfile', 'src']
                    criticalFiles.each { file ->
                        if (!fileExists(file)) {
                            error("‚ùå Fichier critique manquant: ${file}")
                        }
                    }
                    echo '‚úÖ Tous les fichiers critiques sont pr√©sents'
                }
            }
        }
        
        // ========================================
        // STAGE 3: BUILD & TEST MAVEN COMPLET
        // ========================================
        stage('üèóÔ∏è Build & Test Maven') {
            agent {
                docker {
                    image 'maven:3.9-eclipse-temurin-21'
                    args '-v maven-repo:/root/.m2 -v /var/run/docker.sock:/var/run/docker.sock --network host'
                    reuseNode true
                }
            }
            stages {
                // ========================================
                // 3.1: VALIDATION & DEPENDENCIES
                // ========================================
                stage('üì¶ Dependencies & Validation') {
                    steps {
                        echo 'üì¶ R√©solution des d√©pendances Maven...'
                        sh '''
                            mvn dependency:resolve \
                                dependency:resolve-plugins \
                                -B -q
                        '''
                        
                        echo '‚úÖ Validation du projet...'
                        sh 'mvn validate -B'
                        
                        echo '‚úÖ D√©pendances r√©solues et projet valid√©'
                    }
                }
                
                // ========================================
                // 3.2: COMPILATION
                // ========================================
                stage('üî® Compilation') {
                    steps {
                        echo 'üî® Compilation du code source (parall√©lis√©e)...'
                        sh 'mvn clean compile -B -DskipTests -T 2C'
                        
                        script {
                            def compileLog = sh(
                                script: 'find target/classes -name "*.class" | wc -l',
                                returnStdout: true
                            ).trim()
                            echo "‚úÖ ${compileLog} classes compil√©es avec succ√®s"
                        }
                    }
                }
                
                // ========================================
                // 3.3: TESTS UNITAIRES
                // ========================================
                stage('üß™ Tests Unitaires') {
                    when {
                        expression { params.SKIP_TESTS == false }
                    }
                    steps {
                        script {
                            def testProfile = params.BUILD_TYPE == 'QUICK' ? '-Pquick' : '-Pci'
                            echo "üß™ Ex√©cution des tests unitaires (profil: ${testProfile})..."
                            sh """
                                mvn test ${testProfile} \
                                    -Dspring.profiles.active=test \
                                    -Dmaven.test.failure.ignore=true \
                                    -T 2C \
                                    -B
                            """
                        }
                    }
                    post {
                        always {
                            // Publication JUnit
                            junit testResults: '**/target/surefire-reports/*.xml',
                                  allowEmptyResults: true,
                                  skipPublishingChecks: false,
                                  healthScaleFactor: 1.0
                            
                            // Publication JaCoCo
                            jacoco(
                                execPattern: '**/target/jacoco.exec',
                                classPattern: '**/target/classes',
                                sourcePattern: '**/src/main/java',
                                exclusionPattern: '**/*Test*.class,**/*Config*.class,**/*Application*.class,**/entity/**,**/dto/**,**/model/**',
                                minimumLineCoverage: "${COVERAGE_THRESHOLD}",
                                minimumBranchCoverage: "${BRANCH_COVERAGE_THRESHOLD}"
                            )
                            
                            script {
                                def testResults = junit testResults: '**/target/surefire-reports/*.xml'
                                echo "üìä Tests: ${testResults.totalCount} total, ${testResults.passCount} r√©ussis, ${testResults.failCount} √©chou√©s"
                            }
                        }
                    }
                }
                
                // ========================================
                // 3.4: TESTS D'INT√âGRATION
                // ========================================
                stage('üîó Tests d\'Int√©gration') {
                    when {
                        allOf {
                            expression { params.SKIP_TESTS == false }
                            expression { params.RUN_INTEGRATION_TESTS == true }
                        }
                    }
                    steps {
                        echo 'üîó Ex√©cution des tests d\'int√©gration...'
                        sh '''
                            mvn verify \
                                -DskipUnitTests \
                                -Dspring.profiles.active=test \
                                -B
                        '''
                        echo '‚úÖ Tests d\'int√©gration termin√©s'
                    }
                }
                
                // ========================================
                // 3.5: ANALYSE STATIQUE DU CODE
                // ========================================
                stage('üîç Analyse Statique') {
                    parallel {
                        stage('Checkstyle') {
                            steps {
                                echo 'üìê V√©rification du style de code...'
                                sh 'mvn checkstyle:check -B || true'
                            }
                        }
                        stage('PMD') {
                            steps {
                                echo 'üîé Analyse PMD...'
                                sh 'mvn pmd:check -B || true'
                            }
                        }
                        stage('SpotBugs') {
                            steps {
                                echo 'üêõ D√©tection de bugs...'
                                sh 'mvn spotbugs:check -B || true'
                            }
                        }
                    }
                }
                
                // ========================================
                // 3.6: SONARQUBE ANALYSIS
                // ========================================
                stage('üìä SonarQube Analysis') {
                    when {
                        expression { params.BUILD_TYPE != 'QUICK' }
                    }
                    steps {
                        echo 'üìä Analyse qualit√© avec SonarQube...'
                        script {
                            try {
                                withSonarQubeEnv('SonarQube') {
                                    sh '''
                                        mvn sonar:sonar \
                                            -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
                                            -Dsonar.projectName="${SONAR_PROJECT_NAME}" \
                                            -Dsonar.projectVersion=${APP_VERSION} \
                                            -Dsonar.java.binaries=target/classes \
                                            -Dsonar.sources=src/main/java \
                                            -Dsonar.tests=src/test/java \
                                            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
                                            -Dsonar.junit.reportPaths=target/surefire-reports \
                                            -Dsonar.java.coveragePlugin=jacoco \
                                            -Dsonar.exclusions=**/entity/**,**/model/**,**/dto/**,**/config/**,**/DemoApplication.java \
                                            -B
                                    '''
                                }
                                echo '‚úÖ Analyse SonarQube termin√©e'
                            } catch (Exception e) {
                                echo "‚ö†Ô∏è SonarQube non disponible: ${e.message}"
                                echo "‚ö†Ô∏è Le build continue sans SonarQube"
                            }
                        }
                    }
                }
                
                // ========================================
                // 3.7: QUALITY GATE
                // ========================================
                stage('üö¶ Quality Gate') {
                    when {
                        expression { params.BUILD_TYPE != 'QUICK' }
                    }
                    steps {
                        script {
                            try {
                                timeout(time: 5, unit: 'MINUTES') {
                                    def qg = waitForQualityGate()
                                    if (qg.status != 'OK') {
                                        echo "‚ö†Ô∏è Quality Gate: ${qg.status}"
                                        echo "‚ö†Ô∏è Le build continue malgr√© le Quality Gate"
                                        currentBuild.result = 'UNSTABLE'
                                    } else {
                                        echo '‚úÖ Quality Gate: PASSED'
                                    }
                                }
                            } catch (Exception e) {
                                echo "‚ö†Ô∏è Quality Gate timeout: ${e.message}"
                            }
                        }
                    }
                }
                
                // ========================================
                // 3.8: PACKAGING
                // ========================================
                stage('üì¶ Package JAR') {
                    steps {
                        echo 'üì¶ Cr√©ation du package JAR...'
                        sh 'mvn package -DskipTests -B'
                        
                        script {
                            def jarFile = sh(
                                script: 'ls -lh target/*.jar | grep -v original',
                                returnStdout: true
                            ).trim()
                            echo "‚úÖ JAR cr√©√©: ${jarFile}"
                        }
                    }
                    post {
                        success {
                            archiveArtifacts artifacts: 'target/*.jar',
                                           fingerprint: true,
                                           allowEmptyArchive: false,
                                           onlyIfSuccessful: true
                        }
                    }
                }
            }
        }
        
        // ========================================
        // STAGE 4: DOCKER BUILD
        // ========================================
        stage('üê≥ Docker Build') {
            steps {
                echo 'üê≥ Construction des images Docker...'
                script {
                    sh """
                        docker build \
                            -t ${BACKEND_IMAGE}:${IMAGE_TAG} \
                            -t ${BACKEND_IMAGE}:latest \
                            -t ${BACKEND_IMAGE}:${GIT_COMMIT_SHORT} \
                            -t ${BACKEND_IMAGE}:v${APP_VERSION} \
                            --build-arg VERSION=${APP_VERSION} \
                            --build-arg BUILD_NUMBER=${env.BUILD_NUMBER} \
                            --build-arg BUILD_DATE=\$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
                            --build-arg VCS_REF=${GIT_COMMIT_SHORT} \
                            --label "version=${APP_VERSION}" \
                            --label "build=${env.BUILD_NUMBER}" \
                            --label "commit=${GIT_COMMIT_SHORT}" \
                            .
                    """
                    
                    echo '‚úÖ Images Docker cr√©√©es:'
                    echo "   ‚Ä¢ ${BACKEND_IMAGE}:${IMAGE_TAG}"
                    echo "   ‚Ä¢ ${BACKEND_IMAGE}:latest"
                    echo "   ‚Ä¢ ${BACKEND_IMAGE}:${GIT_COMMIT_SHORT}"
                    echo "   ‚Ä¢ ${BACKEND_IMAGE}:v${APP_VERSION}"
                    
                    // V√©rifier la taille de l'image
                    def imageSize = sh(
                        script: "docker images ${BACKEND_IMAGE}:${IMAGE_TAG} --format '{{.Size}}'",
                        returnStdout: true
                    ).trim()
                    echo "üìä Taille de l'image: ${imageSize}"
                }
            }
        }
        
        // ========================================
        // STAGE 5: TESTS DOCKER
        // ========================================
        stage('üß™ Tests Docker') {
            steps {
                echo 'üß™ Tests du conteneur Docker avec MongoDB...'
                script {
                    try {
                        // Nettoyage
                        sh '''
                            docker stop backend-test mongodb-test 2>/dev/null || true
                            docker rm backend-test mongodb-test 2>/dev/null || true
                            docker network rm test-network 2>/dev/null || true
                        '''
                        
                        // R√©seau Docker
                        sh 'docker network create test-network'
                        echo '‚úÖ R√©seau Docker cr√©√©'
                        
                        // MongoDB
                        sh """
                            docker run -d \
                                --name mongodb-test \
                                --network test-network \
                                -e MONGO_INITDB_ROOT_USERNAME=admin \
                                -e MONGO_INITDB_ROOT_PASSWORD=admin123 \
                                mongo:latest
                        """
                        echo '‚úÖ MongoDB d√©marr√©'
                        sleep 15
                        
                        // Backend
                        sh """
                            docker run -d \
                                --name backend-test \
                                --network test-network \
                                -p 8081:8080 \
                                -e SPRING_DATA_MONGODB_HOST=mongodb-test \
                                -e SPRING_DATA_MONGODB_PORT=27017 \
                                -e SPRING_DATA_MONGODB_USERNAME=admin \
                                -e SPRING_DATA_MONGODB_PASSWORD=admin123 \
                                -e SPRING_DATA_MONGODB_DATABASE=commercial_pfe \
                                -e SPRING_DATA_MONGODB_AUTHENTICATION_DATABASE=admin \
                                -e SPRING_PROFILES_ACTIVE=prod \
                                ${BACKEND_IMAGE}:${IMAGE_TAG}
                        """
                        echo '‚úÖ Backend d√©marr√©'
                        sleep 40
                        
                        // Health checks
                        def healthOk = false
                        for (int i = 1; i <= 5; i++) {
                            echo "üîç Health check ${i}/5..."
                            def health = sh(
                                script: 'curl -f http://localhost:8081/actuator/health 2>/dev/null || echo "FAILED"',
                                returnStdout: true
                            ).trim()
                            
                            if (health.contains('UP')) {
                                echo '‚úÖ Health check: PASSED'
                                healthOk = true
                                break
                            }
                            if (i < 5) sleep 10
                        }
                        
                        if (!healthOk) {
                            echo '‚ö†Ô∏è Health check: TIMEOUT'
                            sh 'docker logs backend-test --tail 100'
                        }
                        
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è Erreur Docker Test: ${e.message}"
                        sh 'docker logs backend-test 2>/dev/null || true'
                    } finally {
                        sh '''
                            docker stop backend-test mongodb-test 2>/dev/null || true
                            docker rm backend-test mongodb-test 2>/dev/null || true
                            docker network rm test-network 2>/dev/null || true
                        '''
                    }
                }
            }
        }
        
        // ========================================
        // STAGE 6: SCAN DE S√âCURIT√â
        // ========================================
        stage('üîí Security Scan') {
            when {
                expression { 
                    params.BUILD_TYPE == 'FULL' || params.BUILD_TYPE == 'SECURITY_ONLY' 
                }
            }
            parallel {
                stage('Trivy Scan') {
                    steps {
                        echo 'üîí Scan Trivy des vuln√©rabilit√©s...'
                        script {
                            try {
                                sh """
                                    docker run --rm \
                                        -v /var/run/docker.sock:/var/run/docker.sock \
                                        aquasec/trivy image \
                                        --severity HIGH,CRITICAL \
                                        --format table \
                                        --exit-code 0 \
                                        ${BACKEND_IMAGE}:${IMAGE_TAG}
                                """
                                echo '‚úÖ Scan Trivy termin√©'
                            } catch (Exception e) {
                                echo "‚ö†Ô∏è Trivy non disponible: ${e.message}"
                            }
                        }
                    }
                }
                stage('OWASP Dependency Check') {
                    steps {
                        echo 'üõ°Ô∏è V√©rification des d√©pendances OWASP...'
                        script {
                            try {
                                sh 'mvn org.owasp:dependency-check-maven:check -B || true'
                                echo '‚úÖ OWASP Dependency Check termin√©'
                            } catch (Exception e) {
                                echo "‚ö†Ô∏è OWASP non disponible: ${e.message}"
                            }
                        }
                    }
                }
            }
        }
        
        // ========================================
        // STAGE 7: PUSH DOCKER HUB
        // ========================================
        stage('üì§ Push Docker Hub') {
            when {
                allOf {
                    expression { params.PUSH_TO_DOCKERHUB == true }
                    anyOf {
                        branch 'develop'
                        branch 'main'
                        branch 'master'
                    }
                }
            }
            steps {
                echo 'üì§ Push vers Docker Hub...'
                withCredentials([usernamePassword(
                    credentialsId: 'dockerhub-credentials',
                    usernameVariable: 'DOCKER_USER',
                    passwordVariable: 'DOCKER_PASS'
                )]) {
                    sh '''
                        echo "üîê Connexion Docker Hub..."
                        echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin
                        
                        echo "üì§ Push des images..."
                        docker push ${BACKEND_IMAGE}:${IMAGE_TAG}
                        docker push ${BACKEND_IMAGE}:latest
                        docker push ${BACKEND_IMAGE}:${GIT_COMMIT_SHORT}
                        docker push ${BACKEND_IMAGE}:v${APP_VERSION}
                        
                        docker logout
                    '''
                }
                echo '‚úÖ Images pouss√©es vers Docker Hub'
            }
        }
        
        // ========================================
        // STAGE 8: D√âPLOIEMENT STAGING (OPTIONNEL)
        // ========================================
        stage('üöÄ Deploy Staging') {
            when {
                expression { params.DEPLOY_TO_STAGING == true }
            }
            steps {
                echo 'üöÄ D√©ploiement en environnement staging...'
                script {
                    // Ajoutez ici votre logique de d√©ploiement
                    echo '‚ö†Ô∏è D√©ploiement staging √† impl√©menter'
                }
            }
        }
        
        // ========================================
        // STAGE 9: RAPPORT FINAL
        // ========================================
        stage('üìä Rapport Final') {
            steps {
                script {
                    def buildStatus = currentBuild.result ?: 'SUCCESS'
                    def statusIcon = buildStatus == 'SUCCESS' ? '‚úÖ' : buildStatus == 'UNSTABLE' ? '‚ö†Ô∏è' : '‚ùå'
                    def duration = currentBuild.durationString.replace(' and counting', '')
                    
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '           RAPPORT FINAL DU BUILD'
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo "${statusIcon} Status: ${buildStatus}"
                    echo "üì¶ Build: #${env.BUILD_NUMBER}"
                    echo "üè∑Ô∏è  Version: ${APP_VERSION}"
                    echo "üåø Branch: ${env.BRANCH_NAME ?: 'develop'}"
                    echo "üìù Commit: ${GIT_COMMIT_SHORT}"
                    echo "‚è±Ô∏è  Dur√©e: ${duration}"
                    echo "üîß Type: ${params.BUILD_TYPE}"
                    echo ''
                    echo 'üì¶ ARTEFACTS:'
                    echo "   ‚úì JAR: demo-${APP_VERSION}-SNAPSHOT.jar"
                    echo "   ‚úì Docker: ${BACKEND_IMAGE}:${IMAGE_TAG}"
                    echo "   ‚úì Docker: ${BACKEND_IMAGE}:latest"
                    echo "   ‚úì Docker: ${BACKEND_IMAGE}:v${APP_VERSION}"
                    echo ''
                    echo 'üìä RAPPORTS:'
                    echo "   ‚Ä¢ Tests JUnit: ${env.BUILD_URL}testReport/"
                    echo "   ‚Ä¢ Couverture JaCoCo: ${env.BUILD_URL}jacoco/"
                    echo "   ‚Ä¢ SonarQube: http://localhost:9000/dashboard?id=${SONAR_PROJECT_KEY}"
                    echo ''
                    echo 'üîó LIENS:'
                    echo "   ‚Ä¢ Docker Hub: https://hub.docker.com/r/${DOCKER_USERNAME}/commercial-pfe-backend"
                    echo "   ‚Ä¢ Jenkins: ${env.BUILD_URL}"
                    echo "   ‚Ä¢ GitHub: https://github.com/hamayari/Pfe-Backend"
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                }
            }
        }
    }
    
    post {
        success {
            script {
                echo '‚úÖ‚úÖ‚úÖ PIPELINE R√âUSSIE! ‚úÖ‚úÖ‚úÖ'
                echo 'üéâ Tous les stages ont √©t√© compl√©t√©s avec succ√®s!'
                
                // Notification (√† configurer)
                // emailext subject: "‚úÖ Build ${env.BUILD_NUMBER} - SUCCESS",
                //          body: "Le build a r√©ussi!",
                //          to: "team@example.com"
            }
        }
        unstable {
            echo '‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è PIPELINE INSTABLE ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è'
            echo '‚ö†Ô∏è Certains tests ont √©chou√© ou Quality Gate non pass√©'
        }
        failure {
            echo '‚ùå‚ùå‚ùå PIPELINE √âCHOU√âE ‚ùå‚ùå‚ùå'
            echo '‚ùå Le build a √©chou√©. Consultez les logs.'
        }
        always {
            echo 'üßπ Nettoyage final...'
            sh '''
                # Nettoyage conteneurs
                docker stop backend-test mongodb-test 2>/dev/null || true
                docker rm backend-test mongodb-test 2>/dev/null || true
                docker network rm test-network 2>/dev/null || true
                
                # Nettoyage images non utilis√©es
                docker image prune -f 2>/dev/null || true
            '''
            
            // Publication rapports HTML
            publishHTML([
                allowMissing: true,
                alwaysLinkToLastBuild: true,
                keepAll: true,
                reportDir: 'target/site/jacoco',
                reportFiles: 'index.html',
                reportName: 'JaCoCo Coverage',
                reportTitles: 'Code Coverage Report'
            ])
            
            publishHTML([
                allowMissing: true,
                alwaysLinkToLastBuild: true,
                keepAll: true,
                reportDir: 'target/site',
                reportFiles: 'project-reports.html',
                reportName: 'Maven Site',
                reportTitles: 'Project Reports'
            ])
            
            echo '‚úÖ Nettoyage termin√©'
        }
    }
}
