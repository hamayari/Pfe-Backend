pipeline {
    agent any
    
    tools {
        maven 'maven'
        jdk 'JDK-17'
    }
    
    environment {
        MAVEN_OPTS = '-Xmx2048m -Xms512m'
        DOCKER_IMAGE = 'hamayari/pfe-backend'
        DOCKER_TAG = "${BUILD_NUMBER}"
    }
    
    options {
        timeout(time: 15, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }
    
    stages {
        stage('ğŸ“¥ Checkout') {
            steps {
                echo 'ğŸ“¥ RÃ©cupÃ©ration du code depuis GitHub...'
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/develop']],
                    userRemoteConfigs: [[
                        url: 'https://github.com/hamayari/Pfe-Backend.git',
                        credentialsId: 'dockerhub-credentials'
                    ]]
                ])
                script {
                    def gitCommit = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
                    echo "âœ… Code rÃ©cupÃ©rÃ© - Commit: ${gitCommit}"
                }
            }
        }
        
        stage('ğŸ”¨ Build') {
            steps {
                echo 'ğŸ”¨ Compilation du code source...'
                sh 'mvn clean compile -DskipTests -Dcheckstyle.skip=true -B'
                echo 'âœ… Compilation terminÃ©e'
            }
        }
        
        stage('ğŸ§ª Tests (Unitaires + IntÃ©gration)') {
            steps {
                echo 'ğŸ§ª ExÃ©cution de tous les tests...'
                echo '   âœ” Tests unitaires avec Mockito'
                echo '   âœ” Tests d\'intÃ©gration avec MongoDB embarquÃ© (Flapdoodle)'
                echo '   âœ” Aucune dÃ©pendance externe'
                sh '''
                    mvn test \
                        -Dmaven.test.failure.ignore=true \
                        -Dcheckstyle.skip=true \
                        -Dspring.profiles.active=test \
                        -Dsurefire.timeout=120 \
                        -DforkCount=1 \
                        -DreuseForks=false \
                        -B
                '''
                echo 'âœ… Tests terminÃ©s'
            }
            post {
                always {
                    junit testResults: '**/target/surefire-reports/*.xml', allowEmptyResults: true
                    script {
                        try {
                            def testResults = junit testResults: '**/target/surefire-reports/*.xml'
                            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                            echo "ğŸ“Š RÃ‰SULTATS DES TESTS"
                            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                            echo "Total: ${testResults.totalCount}"
                            echo "âœ… RÃ©ussis: ${testResults.passCount}"
                            echo "âŒ Ã‰chouÃ©s: ${testResults.failCount}"
                            echo "â­ï¸  IgnorÃ©s: ${testResults.skipCount}"
                            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                        } catch (Exception e) {
                            echo "âš ï¸ Aucun rÃ©sultat de test disponible"
                        }
                    }
                }
            }
        }
        
        stage('ğŸ“Š Couverture JaCoCo') {
            steps {
                echo 'ğŸ“Š GÃ©nÃ©ration du rapport de couverture de code...'
                sh 'mvn jacoco:report -Dcheckstyle.skip=true -B'
                echo 'âœ… Rapport JaCoCo gÃ©nÃ©rÃ©'
            }
            post {
                always {
                    jacoco(
                        execPattern: '**/target/jacoco.exec',
                        classPattern: '**/target/classes',
                        sourcePattern: '**/src/main/java',
                        exclusionPattern: '''
                            **/entity/**,
                            **/dto/**,
                            **/config/**,
                            **/model/**,
                            **/exception/**,
                            **/DemoApplication.class
                        '''
                    )
                    script {
                        echo "ğŸ“Š Rapport JaCoCo disponible: ${env.BUILD_URL}jacoco/"
                    }
                }
            }
        }
        
        stage('ğŸ“¦ Package JAR') {
            steps {
                echo 'ğŸ“¦ CrÃ©ation du package JAR exÃ©cutable...'
                sh 'mvn package -DskipTests -Dcheckstyle.skip=true -Dmaven.javadoc.skip=true -B'
                script {
                    def jarFile = sh(
                        script: 'ls -lh target/*.jar | grep -v "original" | awk \'{print $9, $5}\' || echo "JAR crÃ©Ã©"',
                        returnStdout: true
                    ).trim()
                    echo "âœ… ${jarFile}"
                }
            }
            post {
                success {
                    archiveArtifacts artifacts: 'target/*.jar', fingerprint: true, allowEmptyArchive: false
                }
            }
        }
        
        stage('ğŸ³ Build Docker Image') {
            steps {
                echo 'ğŸ³ Construction de l\'image Docker...'
                script {
                    sh """
                        docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} .
                        docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_IMAGE}:latest
                        docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_IMAGE}:develop-latest
                    """
                    
                    def imageSize = sh(
                        script: "docker images ${DOCKER_IMAGE}:${DOCKER_TAG} --format '{{.Size}}'",
                        returnStdout: true
                    ).trim()
                    
                    echo "âœ… Images Docker crÃ©Ã©es:"
                    echo "  ğŸ³ ${DOCKER_IMAGE}:${DOCKER_TAG}"
                    echo "  ğŸ³ ${DOCKER_IMAGE}:latest"
                    echo "  ğŸ³ ${DOCKER_IMAGE}:develop-latest"
                    echo "ğŸ“¦ Taille: ${imageSize}"
                }
            }
        }
        
        stage('ğŸ“¤ Push Docker Hub') {
            steps {
                echo 'ğŸ“¤ Push des images vers Docker Hub...'
                withCredentials([usernamePassword(
                    credentialsId: 'dockerhub-credentials',
                    usernameVariable: 'DOCKER_USER',
                    passwordVariable: 'DOCKER_PASS'
                )]) {
                    sh '''
                        echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin
                    '''
                    
                    script {
                        def tags = [DOCKER_TAG, 'latest', 'develop-latest']
                        
                        tags.each { tag ->
                            try {
                                sh "docker push ${DOCKER_IMAGE}:${tag}"
                                echo "  âœ… Pushed: ${DOCKER_IMAGE}:${tag}"
                            } catch (Exception e) {
                                echo "  âš ï¸ Failed to push ${tag}: ${e.message}"
                            }
                        }
                    }
                    
                    sh 'docker logout'
                    
                    echo "âœ… Images poussÃ©es vers Docker Hub"
                    echo "ğŸ”— https://hub.docker.com/r/hamayari/pfe-backend"
                }
            }
        }
        
        stage('ğŸ“Š Rapport Final') {
            steps {
                script {
                    def buildStatus = currentBuild.result ?: 'SUCCESS'
                    def statusIcon = buildStatus == 'SUCCESS' ? 'âœ…' : buildStatus == 'UNSTABLE' ? 'âš ï¸' : 'âŒ'
                    
                    echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                    echo '                    RAPPORT FINAL DU BUILD'
                    echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                    echo "${statusIcon} STATUS: ${buildStatus}"
                    echo ''
                    echo 'ğŸ“‹ INFORMATIONS BUILD:'
                    echo "  â€¢ Build Number: #${env.BUILD_NUMBER}"
                    echo "  â€¢ Branch: develop"
                    echo ''
                    echo 'ğŸ“¦ ARTEFACTS GÃ‰NÃ‰RÃ‰S:'
                    echo "  â€¢ Docker: ${DOCKER_IMAGE}:${DOCKER_TAG}"
                    echo "  â€¢ Docker: ${DOCKER_IMAGE}:latest"
                    echo "  â€¢ Docker: ${DOCKER_IMAGE}:develop-latest"
                    echo ''
                    echo 'ğŸ“Š RAPPORTS DISPONIBLES:'
                    echo "  â€¢ Tests JUnit: ${env.BUILD_URL}testReport/"
                    echo "  â€¢ Couverture JaCoCo: ${env.BUILD_URL}jacoco/"
                    echo ''
                    echo 'ğŸ”— LIENS UTILES:'
                    echo "  â€¢ Jenkins Build: ${env.BUILD_URL}"
                    echo "  â€¢ Docker Hub: https://hub.docker.com/r/hamayari/pfe-backend"
                    echo "  â€¢ GitHub: https://github.com/hamayari/Pfe-Backend"
                    echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                }
            }
        }
    }
    
    post {
        success {
            echo 'âœ… âœ… âœ… BUILD RÃ‰USSI! âœ… âœ… âœ…'
            echo "ğŸ‰ Tous les stages ont Ã©tÃ© complÃ©tÃ©s avec succÃ¨s"
            echo "ğŸ³ Image disponible: docker pull ${DOCKER_IMAGE}:${DOCKER_TAG}"
        }
        
        unstable {
            echo 'âš ï¸ âš ï¸ âš ï¸ BUILD INSTABLE âš ï¸ âš ï¸ âš ï¸'
            echo "âš ï¸ Certains tests ont Ã©chouÃ© mais le build continue"
        }
        
        failure {
            echo 'âŒ âŒ âŒ BUILD Ã‰CHOUÃ‰ âŒ âŒ âŒ'
            echo "âŒ Le build a rencontrÃ© des erreurs critiques"
            echo "ğŸ’¡ Consultez les logs ci-dessus pour plus de dÃ©tails"
        }
        
        always {
            echo 'ğŸ§¹ Nettoyage des ressources...'
            sh '''
                # Nettoyage des conteneurs de test
                docker ps -a | grep backend-test | awk '{print $1}' | xargs -r docker rm -f || true
                
                # Nettoyage des images non taguÃ©es
                docker images -f "dangling=true" -q | xargs -r docker rmi || true
            '''
            echo 'âœ… Nettoyage terminÃ©'
        }
    }
}
