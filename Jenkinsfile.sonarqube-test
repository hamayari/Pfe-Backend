pipeline {
    agent any
    
    environment {
        MAVEN_OPTS = '-Xmx512m -Xms256m'
        SONAR_PROJECT_KEY = 'Commercial-PFE-Backend'
        SONAR_HOST_URL = 'http://host.docker.internal:9000'
    }
    
    stages {
        stage('üîç Checkout') {
            steps {
                echo '========================================='
                echo 'üìÇ R√©cup√©ration du code source'
                echo '========================================='
                checkout scm
            }
        }
        
        stage('üèóÔ∏è Compilation') {
            steps {
                echo '========================================='
                echo 'üî® Compilation du projet Maven'
                echo '========================================='
                dir('demo') {
                    bat '''
                        echo Compilation en cours...
                        mvn clean compile -DskipTests ^
                        -Dcheckstyle.skip=true ^
                        -Dpmd.skip=true ^
                        -Dspotbugs.skip=true
                    '''
                }
            }
        }
        
        stage('üìä Analyse SonarQube') {
            steps {
                echo '========================================='
                echo 'üîç Analyse de la qualit√© du code'
                echo '========================================='
                dir('demo') {
                    script {
                        // Utilise la configuration SonarQube de Jenkins
                        withSonarQubeEnv('SonarQube') {
                            bat """
                                mvn sonar:sonar ^
                                -Dsonar.projectKey=${SONAR_PROJECT_KEY} ^
                                -Dsonar.host.url=${SONAR_HOST_URL}
                            """
                        }
                    }
                }
            }
        }
        
        stage('‚è≥ Quality Gate') {
            steps {
                echo '========================================='
                echo 'üéØ V√©rification du Quality Gate'
                echo '========================================='
                timeout(time: 5, unit: 'MINUTES') {
                    script {
                        try {
                            // Attend le r√©sultat du Quality Gate de SonarQube
                            def qg = waitForQualityGate()
                            
                            if (qg.status != 'OK') {
                                echo "‚ö†Ô∏è Quality Gate status: ${qg.status}"
                                echo "Le Quality Gate n'est pas pass√©, mais on continue pour le test"
                                // unstable(message: "Quality Gate failed: ${qg.status}")
                            } else {
                                echo "‚úÖ Quality Gate passed!"
                            }
                        } catch (Exception e) {
                            echo "‚ö†Ô∏è Erreur lors de la v√©rification du Quality Gate: ${e.message}"
                            echo "Cela peut √™tre normal si le webhook n'est pas configur√©"
                        }
                    }
                }
            }
        }
        
        stage('üìà R√©sultats') {
            steps {
                echo '========================================='
                echo 'üìä R√âSUM√â DE L\'ANALYSE'
                echo '========================================='
                echo "‚úÖ Compilation: SUCCESS"
                echo "‚úÖ Analyse SonarQube: ENVOY√âE"
                echo "üìç Voir les r√©sultats: ${SONAR_HOST_URL}/dashboard?id=${SONAR_PROJECT_KEY}"
                echo '========================================='
            }
        }
    }
    
    post {
        success {
            echo '========================================='
            echo 'üéâ PIPELINE R√âUSSI!'
            echo '========================================='
            echo '‚úÖ Toutes les √©tapes sont pass√©es'
            echo "üìä Consultez SonarQube: ${SONAR_HOST_URL}"
            echo '========================================='
        }
        failure {
            echo '========================================='
            echo '‚ùå PIPELINE √âCHOU√â'
            echo '========================================='
            echo '‚ö†Ô∏è V√©rifiez les logs ci-dessus'
            echo '========================================='
        }
        always {
            echo '========================================='
            echo 'üßπ Nettoyage termin√©'
            echo '========================================='
        }
    }
}
