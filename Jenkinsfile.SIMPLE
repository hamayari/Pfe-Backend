// ============================================
// JENKINSFILE POUR PIPELINE SIMPLE
// √Ä utiliser si vous copiez le code manuellement
// ============================================

pipeline {
    agent any
    
    environment {
        // Configuration Maven
        MAVEN_OPTS = '-Xmx3072m -Xms1024m'
        
        // Configuration Docker
        DOCKER_USERNAME = 'hamalak'
        BACKEND_IMAGE = "${DOCKER_USERNAME}/commercial-pfe-backend"
        IMAGE_TAG = "${env.BUILD_NUMBER}"
        
        // Configuration SonarQube
        SONAR_PROJECT_KEY = 'Commercial-PFE-Backend'
        SONAR_PROJECT_NAME = 'Commercial PFE Backend'
        
        // Configuration Application
        APP_VERSION = '1.0.0'
        
        // Git
        GIT_COMMIT_SHORT = sh(script: 'git rev-parse --short HEAD 2>/dev/null || echo "local"', returnStdout: true).trim()
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
        timeout(time: 1, unit: 'HOURS')
        disableConcurrentBuilds()
    }
    
    stages {
        // ========================================
        // STAGE 1: BUILD INFO
        // ========================================
        stage('üìã Build Info') {
            steps {
                script {
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '           PIPELINE CI/CD - BACKEND'
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo "Build: #${env.BUILD_NUMBER}"
                    echo "Version: ${APP_VERSION}"
                    echo "Commit: ${GIT_COMMIT_SHORT}"
                    echo "Date: ${new Date().format('yyyy-MM-dd HH:mm:ss')}"
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                }
            }
        }
        
        // ========================================
        // STAGE 2: VERIFICATION CODE
        // ========================================
        stage('üîç V√©rification') {
            steps {
                echo 'üîç V√©rification du code source...'
                script {
                    // V√©rifier que les fichiers essentiels existent
                    if (!fileExists('pom.xml')) {
                        error('‚ùå pom.xml non trouv√©! Assurez-vous que le code est dans le workspace.')
                    }
                    if (!fileExists('src')) {
                        error('‚ùå Dossier src/ non trouv√©!')
                    }
                    if (!fileExists('Dockerfile')) {
                        error('‚ùå Dockerfile non trouv√©!')
                    }
                    echo '‚úÖ Tous les fichiers requis sont pr√©sents'
                }
            }
        }
        
        // ========================================
        // STAGE 3: BUILD & TEST COMPLET
        // ========================================
        stage('üèóÔ∏è Build & Test Complet') {
            agent {
                docker {
                    image 'maven:3.9-eclipse-temurin-21'
                    args '-v maven-repo:/root/.m2 -v /var/run/docker.sock:/var/run/docker.sock'
                    reuseNode true
                }
            }
            stages {
                stage('üì¶ Dependencies') {
                    steps {
                        echo 'üì¶ R√©solution des d√©pendances Maven...'
                        sh 'mvn dependency:resolve dependency:resolve-plugins -B -q'
                        echo '‚úÖ D√©pendances r√©solues'
                    }
                }
                
                stage('üî® Compilation') {
                    steps {
                        echo 'üî® Compilation du projet...'
                        sh 'mvn clean compile -B'
                        echo '‚úÖ Compilation r√©ussie'
                    }
                }
                
                stage('üß™ Tests Unitaires') {
                    steps {
                        echo 'üß™ Ex√©cution des tests unitaires avec JaCoCo...'
                        sh '''
                            mvn test \
                                -Dspring.profiles.active=test \
                                -Dmaven.test.failure.ignore=true \
                                -B
                        '''
                        echo '‚úÖ Tests unitaires termin√©s'
                    }
                    post {
                        always {
                            // Publication des r√©sultats JUnit
                            junit testResults: '**/target/surefire-reports/*.xml', 
                                  allowEmptyResults: true,
                                  skipPublishingChecks: false
                            
                            // Publication du rapport JaCoCo
                            jacoco(
                                execPattern: '**/target/jacoco.exec',
                                classPattern: '**/target/classes',
                                sourcePattern: '**/src/main/java',
                                exclusionPattern: '**/*Test*.class,**/*Config*.class,**/*Application*.class'
                            )
                        }
                    }
                }
                
                stage('üìä SonarQube Analysis') {
                    steps {
                        echo 'üìä Analyse qualit√© du code avec SonarQube...'
                        script {
                            try {
                                withSonarQubeEnv('SonarQube') {
                                    sh '''
                                        mvn sonar:sonar \
                                            -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
                                            -Dsonar.projectName="${SONAR_PROJECT_NAME}" \
                                            -Dsonar.projectVersion=${APP_VERSION} \
                                            -Dsonar.java.binaries=target/classes \
                                            -Dsonar.sources=src/main/java \
                                            -Dsonar.tests=src/test/java \
                                            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
                                            -Dsonar.junit.reportPaths=target/surefire-reports \
                                            -Dsonar.java.coveragePlugin=jacoco \
                                            -B
                                    '''
                                }
                                echo '‚úÖ Analyse SonarQube termin√©e'
                            } catch (Exception e) {
                                echo "‚ö†Ô∏è SonarQube non configur√© ou erreur: ${e.message}"
                                echo "‚ö†Ô∏è Le build continue sans SonarQube"
                            }
                        }
                    }
                }
                
                stage('üîç Quality Gate') {
                    steps {
                        script {
                            try {
                                timeout(time: 5, unit: 'MINUTES') {
                                    def qg = waitForQualityGate()
                                    if (qg.status != 'OK') {
                                        echo "‚ö†Ô∏è Quality Gate status: ${qg.status}"
                                        echo "‚ö†Ô∏è Le build continue malgr√© le Quality Gate"
                                    } else {
                                        echo '‚úÖ Quality Gate: PASSED'
                                    }
                                }
                            } catch (Exception e) {
                                echo "‚ö†Ô∏è Quality Gate non disponible: ${e.message}"
                            }
                        }
                    }
                }
                
                stage('üì¶ Package') {
                    steps {
                        echo 'üì¶ Packaging de l\'application...'
                        sh 'mvn package -DskipTests -B'
                        echo '‚úÖ JAR cr√©√© avec succ√®s'
                    }
                    post {
                        success {
                            archiveArtifacts artifacts: 'target/*.jar', 
                                           fingerprint: true,
                                           allowEmptyArchive: false
                        }
                    }
                }
            }
        }
        
        // ========================================
        // STAGE 4: DOCKER BUILD
        // ========================================
        stage('üê≥ Docker Build') {
            steps {
                echo 'üê≥ Construction de l\'image Docker...'
                script {
                    sh """
                        docker build \
                            -t ${BACKEND_IMAGE}:${IMAGE_TAG} \
                            -t ${BACKEND_IMAGE}:latest \
                            -t ${BACKEND_IMAGE}:${GIT_COMMIT_SHORT} \
                            --build-arg VERSION=${APP_VERSION} \
                            --build-arg BUILD_DATE=\$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
                            --build-arg VCS_REF=${GIT_COMMIT_SHORT} \
                            .
                    """
                    echo '‚úÖ Images Docker cr√©√©es:'
                    echo "   - ${BACKEND_IMAGE}:${IMAGE_TAG}"
                    echo "   - ${BACKEND_IMAGE}:latest"
                    echo "   - ${BACKEND_IMAGE}:${GIT_COMMIT_SHORT}"
                }
            }
        }
        
        // ========================================
        // STAGE 5: DOCKER TEST
        // ========================================
        stage('üß™ Docker Test') {
            steps {
                echo 'üß™ Test du conteneur Docker avec MongoDB...'
                script {
                    try {
                        // Nettoyage pr√©alable
                        sh '''
                            docker stop backend-test mongodb-test 2>/dev/null || true
                            docker rm backend-test mongodb-test 2>/dev/null || true
                            docker network rm test-network 2>/dev/null || true
                        '''
                        
                        // Cr√©ation du r√©seau
                        sh 'docker network create test-network'
                        echo '‚úÖ R√©seau Docker cr√©√©'
                        
                        // D√©marrage MongoDB
                        sh """
                            docker run -d \
                                --name mongodb-test \
                                --network test-network \
                                -e MONGO_INITDB_ROOT_USERNAME=admin \
                                -e MONGO_INITDB_ROOT_PASSWORD=admin123 \
                                mongo:latest
                        """
                        echo '‚úÖ MongoDB d√©marr√©'
                        
                        // Attente MongoDB
                        echo '‚è≥ Attente du d√©marrage de MongoDB (15s)...'
                        sleep 15
                        
                        // D√©marrage du backend
                        sh """
                            docker run -d \
                                --name backend-test \
                                --network test-network \
                                -p 8081:8080 \
                                -e SPRING_DATA_MONGODB_HOST=mongodb-test \
                                -e SPRING_DATA_MONGODB_PORT=27017 \
                                -e SPRING_DATA_MONGODB_USERNAME=admin \
                                -e SPRING_DATA_MONGODB_PASSWORD=admin123 \
                                -e SPRING_DATA_MONGODB_DATABASE=commercial_pfe \
                                -e SPRING_DATA_MONGODB_AUTHENTICATION_DATABASE=admin \
                                -e SPRING_PROFILES_ACTIVE=prod \
                                ${BACKEND_IMAGE}:${IMAGE_TAG}
                        """
                        echo '‚úÖ Backend d√©marr√©'
                        
                        // Attente d√©marrage application
                        echo '‚è≥ Attente du d√©marrage de l\'application (40s)...'
                        sleep 40
                        
                        // V√©rification des logs
                        echo 'üìã Logs du conteneur backend:'
                        sh 'docker logs backend-test --tail 50'
                        
                        // Health check
                        def healthAttempts = 0
                        def maxAttempts = 5
                        def healthOk = false
                        
                        while (healthAttempts < maxAttempts && !healthOk) {
                            healthAttempts++
                            echo "üîç Health check tentative ${healthAttempts}/${maxAttempts}..."
                            
                            def health = sh(
                                script: 'curl -f http://localhost:8081/actuator/health 2>/dev/null || echo "FAILED"',
                                returnStdout: true
                            ).trim()
                            
                            if (health.contains('UP')) {
                                echo '‚úÖ Health check: PASSED'
                                echo "   Response: ${health}"
                                healthOk = true
                            } else {
                                echo "‚ö†Ô∏è Health check tentative ${healthAttempts}: En attente..."
                                if (healthAttempts < maxAttempts) {
                                    sleep 10
                                }
                            }
                        }
                        
                        if (!healthOk) {
                            echo '‚ö†Ô∏è Health check: TIMEOUT apr√®s plusieurs tentatives'
                            echo 'üìã Logs finaux du backend:'
                            sh 'docker logs backend-test'
                        }
                        
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è Erreur lors du test Docker: ${e.message}"
                        sh 'docker logs backend-test 2>/dev/null || true'
                        sh 'docker logs mongodb-test 2>/dev/null || true'
                    } finally {
                        // Nettoyage
                        sh '''
                            docker stop backend-test mongodb-test 2>/dev/null || true
                            docker rm backend-test mongodb-test 2>/dev/null || true
                            docker network rm test-network 2>/dev/null || true
                        '''
                        echo '‚úÖ Nettoyage des conteneurs de test effectu√©'
                    }
                }
            }
        }
        
        // ========================================
        // STAGE 6: PUSH DOCKER HUB (OPTIONNEL)
        // ========================================
        stage('üì§ Push Docker Hub') {
            when {
                expression { 
                    return params.PUSH_TO_DOCKERHUB == true 
                }
            }
            steps {
                echo 'üì§ Push des images vers Docker Hub...'
                withCredentials([usernamePassword(
                    credentialsId: 'dockerhub-credentials',
                    usernameVariable: 'DOCKER_USER',
                    passwordVariable: 'DOCKER_PASS'
                )]) {
                    sh '''
                        echo "üîê Connexion √† Docker Hub..."
                        echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin
                        
                        echo "üì§ Push de l'image avec tag ${IMAGE_TAG}..."
                        docker push ${BACKEND_IMAGE}:${IMAGE_TAG}
                        
                        echo "üì§ Push de l'image latest..."
                        docker push ${BACKEND_IMAGE}:latest
                        
                        echo "üì§ Push de l'image avec commit ${GIT_COMMIT_SHORT}..."
                        docker push ${BACKEND_IMAGE}:${GIT_COMMIT_SHORT}
                        
                        echo "üîì D√©connexion de Docker Hub..."
                        docker logout
                    '''
                }
                echo '‚úÖ Images pouss√©es vers Docker Hub avec succ√®s'
            }
        }
        
        // ========================================
        // STAGE 7: RAPPORT FINAL
        // ========================================
        stage('üìä Rapport Final') {
            steps {
                script {
                    def buildStatus = currentBuild.result ?: 'SUCCESS'
                    def statusIcon = buildStatus == 'SUCCESS' ? '‚úÖ' : '‚ö†Ô∏è'
                    
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '           RAPPORT FINAL DU BUILD'
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo "${statusIcon} Status: ${buildStatus}"
                    echo "üì¶ Build: #${env.BUILD_NUMBER}"
                    echo "üè∑Ô∏è  Version: ${APP_VERSION}"
                    echo "üìù Commit: ${GIT_COMMIT_SHORT}"
                    echo "‚è±Ô∏è  Dur√©e: ${currentBuild.durationString.replace(' and counting', '')}"
                    echo ''
                    echo 'üì¶ ARTEFACTS G√âN√âR√âS:'
                    echo "   ‚úì JAR: demo-${APP_VERSION}-SNAPSHOT.jar"
                    echo "   ‚úì Docker: ${BACKEND_IMAGE}:${IMAGE_TAG}"
                    echo "   ‚úì Docker: ${BACKEND_IMAGE}:latest"
                    echo "   ‚úì Docker: ${BACKEND_IMAGE}:${GIT_COMMIT_SHORT}"
                    echo ''
                    echo 'üìä RAPPORTS DISPONIBLES:'
                    echo "   ‚úì Tests JUnit: ${env.BUILD_URL}testReport/"
                    echo "   ‚úì Couverture JaCoCo: ${env.BUILD_URL}jacoco/"
                    echo ''
                    echo 'üîó LIENS UTILES:'
                    echo "   ‚Ä¢ Docker Hub: https://hub.docker.com/r/${DOCKER_USERNAME}/commercial-pfe-backend"
                    echo "   ‚Ä¢ Jenkins: ${env.BUILD_URL}"
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                }
            }
        }
    }
    
    post {
        success {
            echo '‚úÖ‚úÖ‚úÖ PIPELINE R√âUSSIE AVEC SUCC√àS! ‚úÖ‚úÖ‚úÖ'
        }
        unstable {
            echo '‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è PIPELINE INSTABLE ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è'
        }
        failure {
            echo '‚ùå‚ùå‚ùå PIPELINE √âCHOU√âE ‚ùå‚ùå‚ùå'
        }
        always {
            echo 'üßπ Nettoyage final...'
            sh '''
                docker stop backend-test mongodb-test 2>/dev/null || true
                docker rm backend-test mongodb-test 2>/dev/null || true
                docker network rm test-network 2>/dev/null || true
                docker image prune -f 2>/dev/null || true
            '''
            echo '‚úÖ Nettoyage termin√©'
            
            publishHTML([
                allowMissing: true,
                alwaysLinkToLastBuild: true,
                keepAll: true,
                reportDir: 'target/site/jacoco',
                reportFiles: 'index.html',
                reportName: 'JaCoCo Coverage Report',
                reportTitles: 'Code Coverage'
            ])
        }
    }
    
    parameters {
        booleanParam(
            name: 'PUSH_TO_DOCKERHUB',
            defaultValue: false,
            description: 'Cochez pour pusher les images vers Docker Hub'
        )
    }
}
